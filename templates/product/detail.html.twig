{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://fonts.googleapis.com/css2?family=Krub:wght@400;600;700&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ asset('styles/detailProduct.css') }}" rel="stylesheet"/>
{% endblock %}

{% block title %}
    {{ product.name }}
{% endblock %}

{% block body %}
    <div class="producto-detalle-container">
        {% if is_granted('ROLE_INVITADO') and not is_granted('ROLE_USUARIO') %}
            <div class="guest-alert">
                <p>
                    <i class="fas fa-info-circle"></i>
                    Bienvenido a nuestro catálogo. Para aprovechar todas las funcionalidades, 
                    <a href="{{ path('app_register') }}">regístrate</a> o 
                    <a href="{{ path('app_login') }}">inicia sesión</a>.
                </p>
            </div>
        {% endif %}

        <div class="producto-detalle-grid">
            {% if product.image %}
                <div class="producto-detalle-imagen">
                    <img src="{{ asset('assets/imagenes/' ~ product.image) }}" alt="{{ product.name }}" class="product-image">
                </div>
            {% endif %}

            <div class="producto-detalle-info">
                <h1 class="producto-detalle-titulo">{{ product.name }}</h1>
                <div class="producto-detalle-precio">${{ product.price|number_format(2) }}</div>
                <div class="producto-detalle-descripcion">{{ product.description }}</div>

                {% if product.specifications is defined and (product.specifications|length) > 0 %}
                    <div class="producto-especificaciones">
                        <h3>Especificaciones</h3>
                        <div class="especificaciones-lista">
                            {% for key, value in product.specifications %}
                                <div class="especificacion-item">
                                    <span class="especificacion-label">{{ key }}</span>
                                    <span class="especificacion-valor">{{ value }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <div class="producto-acciones">
                    <div class="columna-izquierda">
                        {% if is_granted('ROLE_USUARIO') %}
                            <div class="cantidad-container">
                                <label for="quantity">Cantidad:</label>
                                <input type="number" id="quantity" name="quantity" min="1" max="{{ product.quantity }}" value="1" required/>
                            </div>
                        {% endif %}

                        {% if is_granted('ROLE_INVITADO') %}
                            <a href="{{ path('app_login') }}" class="btn-guest">
                                <i class="fas fa-heart"></i>
                                Agregar a Favoritos
                            </a>
                        {% elseif is_granted('ROLE_USUARIO') %}
                            {% if product.id not in favoriteProductIds %}
                                <form action="{{ path('add_favorite', { id: product.id }) }}" method="post" class="form-favorito">
                                    <button type="submit" class="btn-accion btn-favorito">
                                        <i class="fas fa-heart"></i>
                                        Agregar a Favoritos
                                    </button>
                                </form>
                            {% else %}
                                <button class="btn-accion btn-favorito" disabled>
                                    <i class="fas fa-heart"></i>
                                    En Favoritos
                                </button>
                            {% endif %}
                        {% endif %}
                    </div>

                    <div class="columna-derecha">
                        {% if is_granted('ROLE_INVITADO') %}
                            <a href="{{ path('app_login') }}" class="btn-guest">
                                <i class="fas fa-shopping-cart"></i>
                                Agregar al Carrito
                            </a>
                            <a href="{{ path('app_login') }}" class="btn-guest">
                                <i class="fas fa-credit-card"></i>
                                Comprar Ahora
                            </a>
                        {% elseif is_granted('ROLE_USUARIO') %}
                            <form action="{{ path('create-preference') }}" method="get" class="form-pago">
                                <button type="submit" class="btn-accion btn-pago">
                                    <i class="fas fa-credit-card"></i>
                                    Comprar Ahora
                                </button>
                            </form>
                            
                            <form id="cartForm" action="{{ path('cart_add_product', { productId: product.id }) }}" method="post" class="form-carrito">
                                <button type="submit" class="btn-accion btn-carrito">
                                    <i class="fas fa-shopping-cart"></i>
                                    Agregar al Carrito
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                <div id="alertaCarrito" class="alerta" style="display: none;"></div>
            </div>
        </div>

        <div class="btn-container">
            <a href="{{ path('product_list') }}" class="btn-volver">
                <i class="fas fa-arrow-left"></i>
                Volver al Catálogo
            </a>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const cartForm = document.getElementById('cartForm');
            const alertaCarrito = document.getElementById('alertaCarrito');
            const quantityInput = document.getElementById('quantity');

            if (cartForm) {
                cartForm.addEventListener('submit', function (event) { 
                    event.preventDefault();
                    
                    const formData = new FormData();
                    formData.append('quantity', quantityInput.value);

                    fetch(cartForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data);
                        alertaCarrito.textContent = data.message;
                        alertaCarrito.style.display = 'block';
                        alertaCarrito.style.backgroundColor = data.success ? 'green' : 'red';

                        setTimeout(() => {
                            alertaCarrito.style.display = 'none';
                        }, 4000);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alertaCarrito.textContent = 'Ocurrió un error inesperado.';
                        alertaCarrito.style.display = 'block';
                        alertaCarrito.style.backgroundColor = 'red';
                    });
                });
            }

            const addToFavoriteButton = document.querySelector('.btn-favorito');
            const favoriteForm = document.querySelector('.form-favorito');
            
            if (addToFavoriteButton && !addToFavoriteButton.disabled && favoriteForm) {
                favoriteForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    
                    fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Producto agregado correctamente');
                            addToFavoriteButton.disabled = true;
                            addToFavoriteButton.innerHTML = '<i class="fas fa-heart"></i> En Favoritos';
                        } else {
                            alert('Hubo un error al agregar el producto a favoritos');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Hubo un error al procesar la solicitud');
                    });
                });
            }
        });
    </script>
{% endblock %}